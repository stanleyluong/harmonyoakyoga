version: 1
frontend:
  environment:
    variables:
      _LIVE_UPDATES: '[{"name":"Node.js","pkg":"node","type":"nvm","version":"20"}]'
      AMPLIFY_DIFF_DEPLOY: false
      AMPLIFY_MONOREPO_APP_ROOT: .
  phases:
    preBuild:
      commands:
        - nvm use 20
        - node --version
        - npm --version
        - echo "Temporarily hiding Next.js config to force static deployment"
        - mv next.config.mjs next.config.mjs.bak || echo "No next.config.mjs found"
        - npm ci
    build:
      commands:
        - echo "Restoring Next.js config for build"
        - mv next.config.mjs.bak next.config.mjs || echo "No backup config found"
        - npm run build
        - echo "Static export completed - files in out directory:"
        - ls -la out/
        - echo "Removing any server-related files"
        - rm -rf out/server/ || echo "No server directory found"
        - find out/ -name "*server*" -delete || echo "No server files found"
        - find out/ -name "*middleware*" -delete || echo "No middleware files found"
        - echo "Creating required-server-files.json for Amplify static deployment"
        - echo '{"version":3,"routes":[],"dynamicRoutes":[],"staticRoutes":[],"dataRoutes":[],"i18n":null,"rewrites":[],"headers":[],"redirects":[],"trailingSlash":true,"buildId":"static-export"}' > out/required-server-files.json
        - echo "Creating server trace files for Amplify compatibility"
        - mkdir -p out/.next
        - echo '{"version":3,"buildId":"static-export","type":"static"}' > out/.next/trace
        - echo '{"version":3,"buildId":"static-export","type":"static"}' > out/.next/build-manifest.json
        - echo "Creating static export manifest"
        - echo '{"version":3,"buildId":"static-export","type":"static","routes":[],"staticRoutes":[],"dynamicRoutes":[],"dataRoutes":[],"i18n":null,"rewrites":[],"headers":[],"redirects":[],"trailingSlash":true}' > out/.next/static-export-manifest.json
        - echo "Verifying static export files"
        - ls -la out/.next/
  artifacts:
    baseDirectory: out
    files:
      - '**/*'
    name: static-export
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
customHeaders:
  - pattern: '**/*'
    headers:
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains'
      - key: 'X-Frame-Options'
        value: 'DENY'
      - key: 'X-Content-Type-Options'
        value: 'nosniff'